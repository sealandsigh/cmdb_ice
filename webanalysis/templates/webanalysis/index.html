{% extends 'base.html' %}
{% load static %}

{% block title %}
日志分析
{% endblock %}
{% block nav_webanalysis %}
active
{% endblock %}

{% block container %}
<div class="row">
    <div class="col-md-6">
        <form class="form-inline">
            <div class="form-group">
                <label class="form-label">文件选择</label>
                <select class="form-control" id="accesslog_file">
                    {% for item in files %}
                    <option value="{{ item.id }}">{{ item.name }}({{ item.created_time }})</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
    <div class="col-md-6">
        <form class="form-inline" method="post" enctype="multipart/form-data" action="{% url 'webanalysis:upload' %}">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label sr-only">上传文件</label>
                <input type="file" name="log">
            </div>
            <input type="submit" value="提交">
        </form>
    </div>
</div>
<div class="row">
    <div class="col-md-6">
        <div id="dist_status_code" style="width: 100%;height: 300px">1</div>
    </div>
    <div class="col-md-6">
        <div id="trend_visit" style="width: 100%;height: 300px">2</div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div id="dist_geo" style="width: 100%;height: 600px">3</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript" src="{% static 'echarts-2.2.7/build/dist/echarts-all.js' %}"></script>
{% endblock %}

{% block js %}
    var chart_dist_status_code = echarts.init(document.getElementById('dist_status_code'));
    var chart_trend_visit = echarts.init(document.getElementById('trend_visit'));
    var chart_dist_geo = echarts.init(document.getElementById('dist_geo'));
    var option_dist_status_code =  {
    title : {
        text: '某站点用户访问来源',
        subtext: '纯属虚构',
        x:'center'
    },
    tooltip : {
        trigger: 'item',
        formatter: "{a} <br/>{b} : {c} ({d}%)"
    },
    legend: {
        orient : 'vertical',
        x : 'left',
        data:[]
    },
    toolbox: {
        show : true,
        feature : {
            mark : {show: true},
            dataView : {show: true, readOnly: false},
            magicType : {
                show: true,
                type: ['pie', 'funnel'],
                option: {
                    funnel: {
                        x: '25%',
                        width: '50%',
                        funnelAlign: 'left',
                        max: 1548
                    }
                }
            },
            restore : {show: true},
            saveAsImage : {show: true}
        }
    },
    calculable : true,
    series : [
        {
            name:'访问来源',
            type:'pie',
            radius : '55%',
            center: ['50%', '60%'],
            data:[]
        }
    ]
};

    var option_trend_visit = {
    tooltip : {
        trigger: 'axis',
        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
        }
    },
    legend: {
        data:['直接访问','邮件营销','联盟广告','视频广告','搜索引擎','百度','谷歌','必应','其他']
    },
    toolbox: {
        show : true,
        orient: 'vertical',
        x: 'right',
        y: 'center',
        feature : {
            mark : {show: true},
            dataView : {show: true, readOnly: false},
            magicType : {show: true, type: ['line', 'bar', 'stack', 'tiled']},
            restore : {show: true},
            saveAsImage : {show: true}
        }
    },
    calculable : true,
    xAxis : [
        {
            type : 'category',
            data : ['周一','周二','周三','周四','周五','周六','周日']
        }
    ],
    yAxis : [
        {
            type : 'value'
        }
    ],
    series : [
        {
            name:'直接访问',
            type:'bar',
            data:[320, 332, 301, 334, 390, 330, 320]
        },
        {
            name:'邮件营销',
            type:'bar',
            stack: '广告',
            data:[120, 132, 101, 134, 90, 230, 210]
        },
        {
            name:'联盟广告',
            type:'bar',
            stack: '广告',
            data:[220, 182, 191, 234, 290, 330, 310]
        },
        {
            name:'视频广告',
            type:'bar',
            stack: '广告',
            data:[150, 232, 201, 154, 190, 330, 410]
        },
        {
            name:'搜索引擎',
            type:'bar',
            data:[862, 1018, 964, 1026, 1679, 1600, 1570],
            markLine : {
                itemStyle:{
                    normal:{
                        lineStyle:{
                            type: 'dashed'
                        }
                    }
                },
                data : [
                    [{type : 'min'}, {type : 'max'}]
                ]
            }
        },
        {
            name:'百度',
            type:'bar',
            barWidth : 5,
            stack: '搜索引擎',
            data:[620, 732, 701, 734, 1090, 1130, 1120]
        },
        {
            name:'谷歌',
            type:'bar',
            stack: '搜索引擎',
            data:[120, 132, 101, 134, 290, 230, 220]
        },
        {
            name:'必应',
            type:'bar',
            stack: '搜索引擎',
            data:[60, 72, 71, 74, 190, 130, 110]
        },
        {
            name:'其他',
            type:'bar',
            stack: '搜索引擎',
            data:[62, 82, 91, 84, 109, 110, 120]
        }
    ]
};
    chart_trend_visit.setOption(option_trend_visit);

    function reload() {
        var id = jQuery('#accesslog_file').val();
        reload_dist_status_code(id);
        reload_trend_visit(id);
    }

    function reload_dist_status_code(id) {
        jQuery.get("{% url 'webanalysis:dist_status_code' %}",{'id':id},function(result) {
            if (result['code'] == 200) {
                option_dist_status_code['legend']['data'] = result['result']['legend']
                option_dist_status_code['series'][0]['data'] = result['result']['series']
                chart_dist_status_code.setOption(option_dist_status_code);
            }
        },'json');
    }
{% endblock %}