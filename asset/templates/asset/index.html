{% extends 'base.html' %}

{% block title %}资产管理{% endblock %}
{% block nav_asset %}active{% endblock %}
{% block container %}
    <table id="table_asset" class="table table-striped table-bordered table table-hover table-condensed">
        <thead>
            <tr>
                <th>名称(IP)</th>
                <th>操作系统</th>
                <th>架构</th>
                <th>内存</th>
                <th>CPU</th>
                <th>磁盘</th>
                <th>发现时间</th>
                <th>最后发现时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
{% endblock %}

{% block js %}
    var table = jQuery('#table_asset').DataTable({
        "language": {
            "processing": "处理中...",
            "lengthMenu": "显示 _MENU_ 项结果",
            "zeroRecords": "没有匹配结果",
            "info": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
            "infoEmpty": "显示第 0 至 0 项结果，共 0 项",
            "infoFiltered": "(由 _MAX_ 项结果过滤)",
            "infoPostFix": "",
            "search": "搜索:",
            "searchPlaceholder": "搜索...",
            "url": "",
            "emptyTable": "表中数据为空",
            "loadingRecords": "载入中...",
            "infoThousands": ",",
            "paginate": {
                "first": "首页",
                "previous": "上页",
                "next": "下页",
                "last": "末页"
            },
            "aria": {
                paginate: {
                    first: '首页',
                    previous: '上页',
                    next: '下页',
                    last: '末页'
                },
                "sortAscending": ": 以升序排列此列",
                "sortDescending": ": 以降序排列此列"
            },
            "decimal": "-",
            "thousands": "."
        },
        ajax: {
            url: '{% url "asset:list_ajax" %}',
            dataSrc: 'result',
        },
        columns: [
            {
                "data": function ( row, type, val, meta ) {
                    return row['name'] + '(' + row['ip'] + ')'
                }
            },
            {
                "data": "os"
            },
            {
                "data": "arch"
            },
            {
                "data": "mem"
            },
            {
                "data": function (row,type,val,meta) {
                    return row["cpu"] + '核'
                }
            },
            {
                "data": "disk"
            },
            {
                "data": "created_time"
            },
            {
                "data": "last_time"
            },
            {
                "data": function(row) {
                    return '<a class="btn btn-success btn-xs btn-edit-asset" href="javascript:void(0)" data-id="' + row['id'] + '">编辑</a>' +
                           '<a class="btn btn-danger btn-xs btn-delete-asset" data-id="' + row['id'] + '" href="javascript:void(0)">删除</a>';
                }
            },
        ]
    });

    jQuery('#table_asset').on('click', '.btn-edit-asset', function() {
    console.log('编辑' + jQuery(this).attr('data-id'));
    table.ajax.reload(null, false);
});

    jQuery('#table_asset').on('click', '.btn-delete-asset', function() {
        var id = jQuery(this).attr('data-id');
        swal({
              title: "确定删除吗？",
              text: "你将无法恢复该虚拟文件！",
              type: "warning",
              showCancelButton: true,
              confirmButtonColor: "#DD6B55",
              confirmButtonText: "确定删除！",
              closeOnConfirm: false
            },
            function(){
                jQuery.get("{% url 'asset:delete_ajax' %}",{'uid':id},function (result) {
                    if (result['code'] == 200) {
                        swal({
                        title: '成功',
                        text: '',
                        type: 'success',
                        closeOnConfirm: 'false'
                    }, function () {
                        //关闭sweetalert
                        swal.close();
                        /*刷新table*/
                        table.ajax.reload(null, false);
                    });
                    } else if (result['code'] == 400) {
                        var errors = [];
                        jQuery.each(result['errors'],function (k,v) {
                            errors.push(v)
                        });
                        swal("验证有误",errors.join('\n'),"error")
                    } else if (result['code'] == 403) {
                        swal({
                      title: "用户未登陆",
                      text: "",
                      timer: 2000,
                      showConfirmButton: false
                        });
                    }
                })
            });
    });
{% endblock %}
